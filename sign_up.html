<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join</title>
    <link rel="icon" type="image/x-icon" href="./assets/img/logo_coloured.svg">
    <link rel="stylesheet" href="./css/side_menu.css">
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/login-signup.css">
    <script src="./js/signupdatabase.js"></script>
    <script src="./js/signup.js"></script>
    <script src="./js/contactsfirebase.js"></script>
    <style> .error-message {
        color: red;
        font-size: 0.9em;
        display: none;
    }
    .inputfield.error {
        border: 2px solid red;
    }</style>
</head>
<body>
    <img class="logo-end" src="imgs/join_logo_dark.png" alt="join-logo">
    <section class="container-login-signup dflex-c-c">
        <div class="signup-mask dflex-c-c column">
            <div class="dflex-c-c column">
                <a href="./index.html" class="arrow-back">
                    <img src="./assets/img/icon_back.svg" alt="arrow-left">
                </a>
                <h1>Sign up</h1>
                <div class="text-line"></div>
            </div>

<!----
            <form onsubmit="return handleSignUp(event)" class="input-container dflex-c-c column">
                <input id="inputSignUpName" class="inputfield" type="text" placeholder="Name" required>
                <div id="inputSignUpNameError" class="error-message">Please enter a valid name (letters and spaces only).</div>
            
                <input id="inputSignUpMail" class="inputfield" type="email" placeholder="Email" required>
                <div id="inputSignUpMailError" class="error-message">Please enter a valid email (e.g., example@domain.com).</div>
            
                <input id="inputSignUpPassword1" class="inputfield" type="password" placeholder="Password" required>
                <div id="inputSignUpPassword1Error" class="error-message">Password must be at least 6 characters, and contain at least one uppercase letter, one lowercase letter, and one number.</div>
            
                <input id="inputSignUpPassword2" class="inputfield" type="password" placeholder="Confirm Password" required>
                <div id="inputSignUpPassword2Error" class="error-message">Passwords do not match.</div>
            
                <div class="checkbox-signup">
                    <input id="checkboxAccept" type="checkbox" name="remember-me" class="cp" required>
                    <span>I accept the <a href="./privacy-police.html">Privacy policy</a></span>
                </div>
                <button type="submit" class="btn-small cp">Sign up</button>
            </form>-->
            <form onsubmit="return handleSignUp(event)" class="input-container dflex-c-c column">
                <input id="inputSignUpName" class="inputfield" type="text" placeholder="Name" required>
                <div id="inputSignUpNameError" class="error-message">Please enter a valid name (letters and spaces only).</div>
            
                <input id="inputSignUpMail" class="inputfield" type="email" placeholder="Email" required>
                <div id="inputSignUpMailError" class="error-message">Please enter a valid email (e.g., example@domain.com).</div>
            
                <input id="inputSignUpPassword1" class="inputfield" type="password" placeholder="Password" required>
                <div id="inputSignUpPassword1Error" class="error-message">Password must be at least 6 characters, and contain at least one uppercase letter, one lowercase letter, and one number.</div>
            
                <input id="inputSignUpPassword2" class="inputfield" type="password" placeholder="Confirm Password" required>
                <div id="inputSignUpPassword2Error" class="error-message">Passwords do not match.</div>
            
                <div class="checkbox-signup">
                    <input id="checkboxAccept" type="checkbox" name="remember-me" class="cp" required>
                    <span>I accept the <a href="./privacy-police.html">Privacy policy</a></span>
                </div>
                <button type="submit" class="btn-small cp">Sign up</button>
            </form>
        
            
        </div>
        <div id="bgSignupSuccesfully" class="d-none dflex-c-c">
            <div class="btn-signup-succesfully dflex-c-c">
                You signed up successfully!
            </div>
        </div>
    </section>
    <section class="login-footer dflex-c-c">
        <a href="./privacy-police.html">Privacy Policy</a>
        <a href="./legal_notice.html">Legal Notice</a>
    </section>

    <script>
    // E-Mail, Name und Passwort Validierung
    document.getElementById('inputSignUpMail').addEventListener('input', validateEmailField);
    document.getElementById('inputSignUpMail').addEventListener('blur', validateEmailField);
    document.getElementById('inputSignUpName').addEventListener('input', validateNameField);
    document.getElementById('inputSignUpName').addEventListener('blur', validateNameField);
    document.getElementById('inputSignUpPassword1').addEventListener('input', validatePasswordField);
    document.getElementById('inputSignUpPassword1').addEventListener('blur', validatePasswordField);
    document.getElementById('inputSignUpPassword2').addEventListener('input', validateConfirmPasswordField);
    document.getElementById('inputSignUpPassword2').addEventListener('blur', validateConfirmPasswordField);

    // Funktion für E-Mail Validierung
    function validateEmailField() {
        const emailInput = document.getElementById('inputSignUpMail');
        const errorMessage = document.getElementById('inputSignUpMailError');
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (emailInput.value.trim() === "" || !emailPattern.test(emailInput.value)) {
            emailInput.classList.add('error');
            errorMessage.style.display = 'block';
        } else {
            emailInput.classList.remove('error');
            errorMessage.style.display = 'none';
        }
    }

    // Funktion für Name Validierung
    function validateNameField() {
        const nameInput = document.getElementById('inputSignUpName');
        const errorMessage = document.getElementById('inputSignUpNameError');
        // Nur Buchstaben und Leerzeichen sind erlaubt (keine Zahlen oder Sonderzeichen)
        const namePattern = /^[A-Za-z\s]+$/;

        if (nameInput.value.trim() === "" || !namePattern.test(nameInput.value)) {
            nameInput.classList.add('error');
            errorMessage.style.display = 'block';
        } else {
            nameInput.classList.remove('error');
            errorMessage.style.display = 'none';
        }
    }

    // Funktion für Passwort Validierung
    function validatePasswordField() {
        const passwordInput = document.getElementById('inputSignUpPassword1');
        const errorMessage = document.getElementById('inputSignUpPassword1Error');
        const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/; // Mindestens 6 Zeichen, ein Großbuchstabe, ein Kleinbuchstabe, eine Zahl

        if (passwordInput.value.trim() === "" || !passwordPattern.test(passwordInput.value)) {
            passwordInput.classList.add('error');
            errorMessage.style.display = 'block';
        } else {
            passwordInput.classList.remove('error');
            errorMessage.style.display = 'none';
        }
    }

    // Funktion für Passwort Bestätigung Validierung
    function validateConfirmPasswordField() {
        const passwordInput = document.getElementById('inputSignUpPassword1');
        const confirmPasswordInput = document.getElementById('inputSignUpPassword2');
        const errorMessage = document.getElementById('inputSignUpPassword2Error');

        if (confirmPasswordInput.value.trim() !== passwordInput.value.trim()) {
            confirmPasswordInput.classList.add('error');
            errorMessage.style.display = 'block';
        } else {
            confirmPasswordInput.classList.remove('error');
            errorMessage.style.display = 'none';
        }
    }

    // Hauptanmeldefunktion
    async function handleSignUp(event) {
        event.preventDefault(); // Verhindert das Formularabsenden

        const usersArray = await loadUsers();
        const emailField = document.getElementById("inputSignUpMail");
        const passwordField = document.getElementById("inputSignUpPassword1");
        const confirmPasswordField = document.getElementById("inputSignUpPassword2");
        const acceptCheckbox = document.getElementById("checkboxAccept");
        const errorDisplay = document.getElementById("passwordIncorrect");

        // Überprüfen ob der Benutzer die AGB akzeptiert hat
        if (!acceptCheckbox.checked) {
            displayErrorMessage("You must accept the terms of use", acceptCheckbox);
            return;
        }

        // Überprüfen der E-Mail-Verfügbarkeit
        if (!checkEmailAvailability(usersArray, emailField.value)) {
            displayErrorMessage("Email is already registered", emailField);
            return;
        }

        // Benutzerobjekt erstellen
        let newUser = buildUserObject();

        // Überprüfen des Passworts und der Bestätigung
        if (await verifyPassword(newUser, passwordField, confirmPasswordField)) {
            showSuccessMessage();
        }
    }

    async function checkEmailAvailability(usersArray, email) {
        return !usersArray.some((user) => user.mail === email);
    }

    async function verifyPassword(user, passwordField, confirmPasswordField) {
        const password = passwordField.value.trim();
        const confirmPassword = confirmPasswordField.value.trim();

        if (!password || !confirmPassword) {
            displayErrorMessage("Passwords cannot be empty", confirmPasswordField);
            return false;
        }
        if (password === confirmPassword) {
            await submitData("users", user);
            return true;
        } else {
            displayErrorMessage("Passwords do not match", confirmPasswordField);
            return false;
        }
    }

    async function loadUsers() {
        let usersArray = [];
        let usersData = await fetchData("users");
        for (let [userID, userData] of Object.entries(usersData || {})) {
            userData.id = userID;
            usersArray.push(userData);
        }
        return usersArray;
    }

    function displayErrorMessage(message, targetElement) {
        let errorElement = document.getElementById("passwordIncorrect");
        errorElement.classList.remove("d-none");
        errorElement.innerText = message;
        targetElement.style.border = "2px solid red";
    }

    function buildUserObject() {
        let name = document.getElementById("inputSignUpName").value;
        let email = document.getElementById("inputSignUpMail").value;
        let password = document.getElementById("inputSignUpPassword1").value;
        return { name, initials: getInitials(name), password, mail: email };
    }

    function showSuccessMessage() {
        document.getElementById("bgSignupSuccesfully").classList.remove("d-none");
        setTimeout(() => {
            window.location.href = "./index.html";
        }, 1500);
    }

    function getInitials(name) {
        return name
            .split(" ")
            .filter(Boolean)
            .map((word) => word[0].toUpperCase())
            .join("");
    }
    </script>

</body>
</html>